---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/gateway.envoyproxy.io/envoypatchpolicy_v1alpha1.json
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: homepage-sw-static
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: envoy-internal
  type: JSONPatch
  jsonPatches:
    - type: type.googleapis.com/envoy.config.listener.v3.Listener
      name: network/envoy-internal/https
      operation:
        op: add
        jsonPath: >
          $.filter_chains[*].filters[
            ?(@.name=="envoy.filters.network.http_connection_manager")
          ].typed_config.http_filters[
            ?(@.name=="envoy.filters.http.router")
          ]
        value:
          name: envoy.filters.http.lua
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
            inline_code: |
              function envoy_on_request(handle)
                local path = handle:headers():get(":path")
                if path == "/sw.js" then
                  handle:respond(
                    {
                      [":status"] = "200",
                      ["content-type"] = "application/javascript",
                      ["cache-control"] = "public, max-age=31536000, immutable"
                    },
                    [[
                      const CACHE_NAME = 'homepage-shell-v1';

                      self.addEventListener('install', e => self.skipWaiting());
                      self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));

                      self.addEventListener('fetch', event => {
                        const url = new URL(event.request.url);
                        if (
                          event.request.method !== 'GET' ||
                          url.origin !== self.location.origin ||
                          url.pathname.startsWith('/api/')
                        ) {
                          return;
                        }

                        event.respondWith((async () => {
                          const cache = await caches.open(CACHE_NAME);
                          const cached = await cache.match(event.request);
                          if (cached) return cached;

                          const response = await fetch(event.request);
                          if (response.status === 200) {
                            cache.put(event.request, response.clone());
                          }
                          return response;
                        })());
                      });
                    ]]
                  )
                end
              end
